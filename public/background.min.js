function makeid(){for(var e="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=0;t<5;t++)e+=r.charAt(Math.floor(Math.random()*r.length));return e}function captureDesktop(){if(recorder&&recorder.stream&&recorder.stream.onended)return void recorder.stream.onended();chrome.browserAction.setIcon({path:"img/icon.png"});try{chrome.desktopCapture.chooseDesktopMedia(["window","audio"],onAccessApproved)}catch(e){getUserMediaError()}}function getChromeVersion(){var e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);return e?parseInt(e[2],10):52}function onAccessApproved(e){function r(e){var r={type:"video",disableLogs:!1,recorderType:MediaStreamRecorder,mimeType:"video/webm;codecs=vp9",audioBitsPerSecond:6e4,videoBitsPerSecond:1024e3};if(audioStream&&audioStream.getAudioTracks&&audioStream.getAudioTracks().length){audioPlayer=document.createElement("audio"),audioPlayer.src=URL.createObjectURL(audioStream),audioPlayer.onended=function(){console.warn("Audio player is stopped.")},audioPlayer.onpause=function(){console.warn("Audio player is paused.")},audioPlayer.play(),audioPlayer.muted=!0,context=new AudioContext;var t=context.createGain();t.connect(context.destination),t.gain.value=0,mediaStreamSource=context.createMediaStreamSource(audioStream),mediaStreamSource.connect(t),mediaStreamDestination=context.createMediaStreamDestination(),mediaStreamSource.connect(mediaStreamDestination),e.addTrack(mediaStreamDestination.stream.getAudioTracks()[0])}recorder=RecordRTC(e,r),chrome.windows.getLastFocused({populate:!1},function(e){chrome.windows.update(e.id,{focused:!0,drawAttention:!0})});try{startTime=(new Date).getTime(),recorder.startRecording(),alreadyHadGUMError=!1}catch(e){getUserMediaError()}recorder.stream=e,isRecording=!0,onRecording(),recorder.stream.onended=function(){recorder&&recorder.stream&&(recorder.stream.onended=function(){}),stopScreenRecording();var e=new Date,r=e.getDate(),t=e.getMonth()+1,o=e.getFullYear();r<10&&(r="0"+r),t<10&&(t="0"+t),e=r+"."+t+"."+o,newVideo={title:(new Date).toISOString().replace(/:|\./g,"-"),date:e,totalTime:(new Date).getTime()-startTime,clicks:clicks,positions:positions}},recorder.stream.getVideoTracks()[0].onended=function(){recorder&&recorder.stream&&recorder.stream.onended&&recorder.stream.onended()},initialTime=Date.now(),timer=setInterval(checkTime,100)}if(!e||!e.toString().length)return chrome.tabs.remove(recorderTab),recorderTab=!1,getChromeVersion()<53?void getUserMediaError():(askToStopExternalStreams(),void setDefaults());chrome.downloads.setShelfEnabled(!1),chrome.tabs.query({},function(e){for(var r=0;r<e.length;r++)chrome.tabs.sendMessage(e[r].id,{action:"startRecording"})});var t={audio:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e},optional:[]},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e},optional:[{maxFrameRate:15}]}};resolutions.maxWidth&&resolutions.maxHeight&&(t.video.mandatory.maxWidth=resolutions.maxWidth,t.video.mandatory.maxHeight=resolutions.maxHeight),navigator.webkitGetUserMedia(t,r,getUserMediaError)}function askToStopExternalStreams(){try{runtimePort.postMessage({stopStream:!0,messageFromContentScript1234:!0})}catch(e){}}function stopScreenRecording(){isRecording=!1,recorder.stopRecording(function(){recorder.getDataURL(function(e){function r(e,r,t){var o=new XMLHttpRequest;o.onreadystatechange=function(){4==o.readyState&&200==o.status&&t(o.responseText)},o.open("POST",e),o.send(r)}newVideo.blob=e;var t=makeid()+".webm",o=new FormData,n="http://video2sop.com/";o.append("video-filename",t),o.append("video-blob",recorder.getBlob()),r(n+"download.php",o,function(e){newVideo.src=n+e})}),chrome.tabs.create({url:chrome.extension.getURL("index.html")}),setTimeout(function(){setDefaults()},1e3),askToStopExternalStreams();try{peer.close(),peer=null}catch(e){}try{audioPlayer.src=null,mediaStreamDestination.disconnect(),mediaStreamSource.disconnect(),context.close(),context.disconnect(),context=null}catch(e){}}),timer&&clearTimeout(timer),setBadgeText(""),chrome.browserAction.setTitle({title:"Record Screen"})}function setDefaults(){chrome.browserAction.setIcon({path:"img/icon.png"}),recorder&&recorder.stream&&(recorder.stream.stop(),recorder&&recorder.stream&&recorder.stream.onended&&recorder.stream.onended()),recorder=null,isRecording=!1,imgIndex=0}function onRecording(){return chrome.browserAction.setIcon({path:"img/"+img[imgIndex]}),imgIndex++,imgIndex>img.length-1&&(imgIndex=img.length-1,reverse=!0),isRecording?void setTimeout(onRecording,800):void chrome.browserAction.setIcon({path:"img/icon.png"})}function setBadgeText(e){chrome.browserAction.setBadgeBackgroundColor({color:[255,0,0,255]}),chrome.browserAction.setBadgeText({text:e+""})}function checkTime(){if(initialTime){var e=Date.now()-initialTime,r=convertTime(e);setBadgeText(r),chrome.browserAction.setTitle({title:"Recording duration: "+r})}}function convertTime(e){var r=Math.floor(e/1e3),t=Math.floor(r/60),o=r-60*t;return t+="",o+="",1===o.length&&(o="0"+o),t+":"+o}function getUserMediaError(){return alreadyHadGUMError?(askToStopExternalStreams(),void setDefaults()):(audioStream=!1,alreadyHadGUMError=!0,videoMaxFrameRates="",videoCodec="Default",void captureDesktop())}function executeScript(e){chrome.tabs.update(e,{active:!0})}function createAnswer(e){peer=new webkitRTCPeerConnection(null),peer.onicecandidate=function(e){if(e&&!e.candidate)try{runtimePort.postMessage({sdp:peer.localDescription,messageFromContentScript1234:!0})}catch(e){}},peer.oniceconnectionstatechange=function(){peer&&console.debug("ice-state",{iceConnectionState:peer.iceConnectionState,iceGatheringState:peer.iceGatheringState,signalingState:peer.signalingState})},peer.onaddstream=function(e){audioStream=e.stream,captureDesktop()},peer.setRemoteDescription(new RTCSessionDescription(e)),peer.createAnswer(function(e){peer.setLocalDescription(e)},function(){},{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!1}})}var recorderTab,runtime=chrome.runtime.connect(),clicks,positions=[];chrome.runtime.onMessage.addListener(function(e,r,t){if(isRecording&&e.newClick){var o=e.newClick;o.time-=startTime,clicks.push(o)}if(e.action)switch(e.action){case"newVideo":clicks=[],positions=[],executed=!1,newVideo=!1,recorderTab&&chrome.tabs.remove(recorderTab),chrome.tabs.create({url:chrome.extension.getURL("recorder.html"),active:!1},function(e){recorderTab=e.id});break;case"stopRecording":isRecording&&(captureDesktop(),chrome.tabs.query({},function(e){for(var r=0;r<e.length;r++)chrome.tabs.sendMessage(e[r].id,{action:"stopRecording"});setTimeout(function(){chrome.tabs.sendMessage(recorderTab,{action:"getVoice"},function(e){newVideo.voice=e.recordedVoice,chrome.tabs.remove(recorderTab),recorderTab=!1})},5e3)}));break;case"getVideo":t(void 0!==newVideo.voice?{video:newVideo}:{video:"pending"})}});var runtimePort;chrome.runtime.onConnect.addListener(function(e){runtimePort=e,runtimePort.onMessage.addListener(function(e){e&&e.messageFromContentScript1234&&e.sdp&&createAnswer(e.sdp)})}),chrome.browserAction.setIcon({path:"img/icon.png"}),runtime.onDisconnect.addListener(function(){chrome.tabs.query({},function(e){for(var r=0;r<e.length;r++)e[r].url.indexOf("chrome://")==-1&&chrome.tabs.executeScript(e[r].id,{file:"public/listener.min.js"})})});var resolutions={maxWidth:29999,maxHeight:8640},audioStream=!0,videoMaxFrameRates="",recorder,peer,newVideo,isRecording=!1,imgIndex=0,img=["progress-1.png","progress-2.png","progress-3.png","progress-4.png","progress-5.png"],initialTime,timer,alreadyHadGUMError=!1,audioPlayer,context,mediaStreamSource,mediaStreamDestination,startTime;