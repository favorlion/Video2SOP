function makeid(){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",a=0;a<5;a++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}function calcArrowAngle(e,t,a,n){var o,r,s=0;return o=a-e,r=n-t,s=0===o?0===r?0:r>0?Math.PI/2:3*Math.PI/2:0===r?o>0?0:Math.PI:o<0?Math.atan(r/o)+Math.PI:r<0?Math.atan(r/o)+2*Math.PI:Math.atan(r/o),180*s/Math.PI+90}function addArrowToCanvas(e,t,a){function n(e){var t,a,n,o;"arrow_end"===e.pointType?(e.line.set("x2",e.get("left")),e.line.set("y2",e.get("top"))):(e.line.set("x1",e.get("left")),e.line.set("y1",e.get("top"))),e.line._setWidthHeight(),t=e.line.get("x1"),a=e.line.get("y1"),n=e.line.get("x2"),o=e.line.get("y2"),angle=calcArrowAngle(t,a,n,o),"arrow_end"===e.pointType?e.arrow.set("angle",angle-180):e.set("angle",angle-180),e.line.setCoords(),canvas.renderAll()}function o(){var e=(r.x1+r.x2)/2,t=(r.y1+r.y2)/2,a=r.left-e,n=r.top-t;r.arrow.set({left:r.x1+a,top:r.y1+n}).setCoords(),r.circle.set({left:r.x2+a,top:r.y2+n}).setCoords(),r.set({x1:r.x1+a,y1:r.y1+n,x2:r.x2+a,y2:r.y2+n}),r.set({left:(r.x1+r.x2)/2,top:(r.y1+r.y2)/2})}var r,s,i,c,l=makeid();c="left"===a?[e+130,t,e+230,t]:[e-130,t,e-230,t],r=new fabric.Line(c,{strokeWidth:8,fill:"green",stroke:"green",originX:"center",originY:"center",name:l,lockScalingX:!0,lockScalingY:!0}),r.setControlsVisibility({tl:!1,tr:!0,bl:!1,br:!1,ml:!1,mt:!1,mr:!1,mb:!1,mtr:!1});var v=(r.x1+r.x2)/2,g=(r.y1+r.y2)/2;deltaX=r.left-v,deltaY=r.top-g,s=new fabric.Triangle({left:r.get("x1")+deltaX,top:r.get("y1")+deltaY,originX:"center",originY:"center",hasBorders:!1,hasControls:!1,lockScalingX:!0,lockScalingY:!0,stroke:"transparent",lockRotation:!0,pointType:"arrow_start",hasRotatingPoint:!1,angle:45,width:25,height:25,fill:"green",name:l}),s.line=r,i=new fabric.Circle({left:r.get("x2")+deltaX,top:r.get("y2")+deltaY,radius:10,originX:"center",originY:"center",hasBorders:!1,hasControls:!1,lockScalingX:!0,lockScalingY:!0,lockRotation:!0,pointType:"arrow_end",fill:"transparent",name:l}),i.line=r,r.customType=s.customType=i.customType="arrow",r.circle=s.circle=i,r.arrow=i.arrow=s,s.set("angle",calcArrowAngle(r.get("x1"),r.get("y1"),r.get("x2"),r.get("y2"))-180),canvas.add(r,s,i),s.on("moving",function(){n(s)}),i.on("moving",function(){n(i)}),r.on("moving",function(){o()})}var canvas,bg;$(function(){function e(){var e=canvas.getActiveObject();if(e){if("rect_blur"===e.get("name")&&stackBlurCanvasRGBA("canvas",0,0,0,0,0),e.get("customType")&&"arrow"===e.get("customType")){for(var t=canvas.getObjects(),a=e.get("name"),n=canvas.size(),o=0,r=n;o<r;o++)void 0!==t[o]&&t[o].customType&&"arrow"===t[o].customType&&t[o].name===a&&t[o].remove();t=canvas.getObjects();for(var o=0,r=n;o<r;o++)void 0!==t[o]&&t[o].type&&"triangle"===t[o].type&&t[o].name===a&&t[o].remove()}else e.remove();setTimeout(function(){canvas.deactivateAll()},0)}canvas.renderAll(),$("#palette").hide()}var t,a,n,o=!1;canvas=new fabric.Canvas("canvas",{uniScaleTransform:!0,selectionColor:"rgba(0,0,0,0.1)",selectionBorderColor:"#000",selectionLineWidth:2,selection:!1,hoverCursor:"pointer"}),canvas.freeDrawingBrush.width=4;var r={tl:!0,tr:!0,bl:!0,br:!0,ml:!1,mt:!1,mr:!1,mb:!1,mtr:!1};fabric.Canvas.prototype.customiseControls({tr:{action:function(t,a){e()},cursor:"pointer"}}),fabric.Object.prototype.customiseCornerIcons({tl:{icon:"img/point.png"},tr:{icon:"img/cross.png"},bl:{icon:"img/point.png"},br:{icon:"img/point.png"},settings:{borderColor:"#929292",cornerSize:22,cornerShape:"rect",cornerBackgroundColor:"transparent",cornerPadding:6}}),canvas.on("after:render",function(e){for(var t=canvas.getContext("2d"),a=canvas.getObjects(),n=canvas.size(),o=0,r=n;o<r;o++)void 0!==a[o]&&"crop"===a[o].name&&t.clearRect(a[o].get("left"),a[o].get("top"),a[o].get("width"),a[o].get("height"))}),canvas.on("object:selected",function(e){return!e.target.pointType||"arrow_end"!==e.target.pointType&&"arrow_start"!==e.target.pointType?("path"!==canvas.getActiveObject().get("type")&&"line"!==canvas.getActiveObject().get("type")||canvas.getActiveObject().set("hasRotatingPoint",!1),void("rect_blur"!==e.target.name&&(e.target.set("padding",15),$("#delete").removeClass("disabled"),$("#deselect").removeClass("disabled"),$("#palette").show()))):($("#palette").hide(),$("#delete").addClass("disabled"),void $("#deselect").addClass("disabled"))}),canvas.on("selection:cleared",function(){var e;e="undefined"!=typeof canvas.getActiveObject()?canvas.getActiveObject():canvas.getActiveGroup(),$("#delete").addClass("disabled"),$("#deselect").addClass("disabled"),$("#palette").hide()}),$("#edit-area").mouseover(function(e){o?canvas.defaultCursor="crosshair":canvas.defaultCursor="default"}),$(document).on("click","#delete",e),document.addEventListener("keydown",function(t){46===t.keyCode&&null!=canvas.getActiveObject()&&e()}),$(document).on("click","#palette li",function(){if($("#palette").find("li.active").removeClass("active"),$(this).addClass("active"),n=$(this).find("a").attr("class"),canvas.getActiveObject())switch(canvas.getActiveObject().get("type")){case"i-text":canvas.getActiveObject().set("textBackgroundColor",n),canvas.getActiveObject().set("fill","yellow"===n?"#000":"#fff");break;case"line":case"triangle":for(var e=canvas.getObjects(),t=0,a=canvas.size();t<a;t++)e[t].customType&&"arrow"===e[t].customType&&canvas.getActiveObject().get("name")===e[t].name&&"arrow_end"!==e[t].pointType&&("arrow_start"===e[t].pointType?e[t].setFill(n):e[t].setStroke(n));break;case"path":canvas.getActiveObject().set("stroke",n);break;case"rect":canvas.getActiveObject().set("stroke",n)}canvas.renderAll(),canvas.freeDrawingBrush.color=$("#palette").find("li.active a").attr("class")}),$(document).bind("toolDeactivated",function(){$("#palette").hide(),canvas.defaultCursor="default"}),$(document).on("click","ul.nav li",function(){if(canvas.isDrawingMode=!1,o=!0,canvas.off("mouse:down"),canvas.off("mouse:move"),canvas.off("mouse:up"),!$(this).is("#delete")){if(n=$("#palette").find("li.active a").attr("class"),$("#palette").hide(),$(this).hasClass("active")||"save"===$(this).attr("id"))return $(this).removeClass("active"),void(o=!1);switch($("ul.nav").find("li.active").removeClass("active"),$(this).addClass("active"),t=$("ul.nav li.active a"),t.attr("class")){case"text":$("#palette").show();break;case"arrow":$("#palette").show();var e,a,s,i=1;canvas.on("mouse:down",function(t){function o(e){var t,a,n,o;"arrow_start"===e.pointType?(e.line.set("x2",e.get("left")),e.line.set("y2",e.get("top"))):(e.line.set("x1",e.get("left")),e.line.set("y1",e.get("top"))),e.line._setWidthHeight(),t=e.line.get("x1"),a=e.line.get("y1"),n=e.line.get("x2"),o=e.line.get("y2"),angle=calcArrowAngle(n,o,t,a),"arrow_end"===e.pointType?e.triangle.set("angle",angle-180):e.set("angle",angle-180),e.line.setCoords(),canvas.renderAll()}function r(){var t=(e.x1+e.x2)/2,a=(e.y1+e.y2)/2,n=e.left-t,o=e.top-a;e.triangle.set({left:e.x2+n,top:e.y2+o}).setCoords(),e.circle.set({left:e.x1+n,top:e.y1+o}).setCoords(),e.set({x1:e.x1+n,y1:e.y1+o,x2:e.x2+n,y2:e.y2+o}),e.set({left:(e.x1+e.x2)/2,top:(e.y1+e.y2)/2})}s=!0;var c=canvas.getPointer(t.e),l=[Math.round(c.x/i)*i,Math.round(c.y/i)*i,c.x,c.y],v=makeid();e=new fabric.Line(l,{strokeWidth:8,fill:n,stroke:n,originX:"center",originY:"center",name:v,lockScalingX:!0,lockScalingY:!0}),e.setControlsVisibility({tl:!1,tr:!0,bl:!1,br:!1,ml:!1,mt:!1,mr:!1,mb:!1,mtr:!1}),centerX=(e.x1+e.x2)/2,centerY=(e.y1+e.y2)/2,deltaX=e.left-centerX,deltaY=e.top-centerY,a=new fabric.Triangle({left:e.get("x1")+deltaX,top:e.get("y1")+deltaY,originX:"center",originY:"center",hasBorders:!1,hasControls:!1,lockScalingX:!0,lockScalingY:!0,stroke:"transparent",lockRotation:!0,pointType:"arrow_start",hasRotatingPoint:!1,angle:-45,width:25,height:25,fill:n,name:v}),a.line=e,circle=new fabric.Circle({left:e.get("x2")+deltaX,top:e.get("y2")+deltaY,radius:10,originX:"center",originY:"center",hasBorders:!1,hasControls:!1,lockScalingX:!0,lockScalingY:!0,lockRotation:!0,pointType:"arrow_end",fill:"transparent",name:v}),circle.line=e,e.customType=a.customType=circle.customType="arrow",e.circle=a.circle=circle,e.triangle=circle.triangle=a,a.on("moving",function(){o(a)}),circle.on("moving",function(){o(circle)}),e.on("moving",function(){r()}),canvas.add(e,a,circle)}),canvas.on("mouse:move",function(t){if(s){var n=canvas.getPointer(t.e);e.set({x2:n.x,y2:n.y}),a.set({left:n.x+deltaX,top:n.y+deltaY,angle:calcArrowAngle(e.x1,e.y1,e.x2,e.y2)}),canvas.renderAll()}}),canvas.on("mouse:up",function(n){s=!1,canvas.off("mouse:down"),canvas.off("mouse:move"),canvas.off("mouse:up"),e.setCoords(),a.setCoords(),circle.setCoords();var o,r;canvas.off("mouse:over").on("mouse:over",function(e){r=!0,o=e.target.get("fill"),e.target&&!canvas.getActiveObject()?("arrow_start"===e.target.get("pointType")?e.target.set("fill","black"):"arrow_end"===e.target.get("pointType")&&e.target.set("fill","black"),canvas.renderAll()):r=!1}),canvas.off("mouse:out").on("mouse:out",function(e){if(e.target&&r&&e.target.get("pointType")){if("arrow_start"===e.target.get("pointType"))e.target.set("fill",o);else{if("arrow_end"!==e.target.get("pointType"))return;e.target.set("fill","transparent")}r=!1,canvas.discardActiveObject(),canvas.renderAll()}}),t.parent().removeClass("active").trigger("toolDeactivated")});break;case"pen":$("#palette").show(),canvas.freeDrawingBrush.color=$("#palette").find("li.active a").attr("class"),canvas.freeDrawingBrush.hasRotatingPoint=!1,canvas.isDrawingMode=!0;break;case"figure":$("#palette").show();var c,s,l,v;canvas.on("mouse:down",function(e){s=!0;var t=canvas.getPointer(e.e);l=t.x,v=t.y,c=new fabric.Rect({left:l,top:v,originX:"left",originY:"top",width:t.x-l,height:t.y-v,strokeWidth:4,fill:"transparent",opacity:1,stroke:$("#palette").find("li.active a").attr("class"),transparentCorners:!1,hasRotatingPoint:!1}),c.setControlsVisibility(r),c.on({scaling:function(e){var t=this,a=t.width*t.scaleX,n=t.height*t.scaleY;t.strokeWidth;t.set({height:n,width:a,scaleX:1,scaleY:1})}}),canvas.add(c)}),canvas.on("mouse:move",function(e){if(s){var t=canvas.getPointer(e.e);l>t.x&&c.set({left:Math.abs(t.x)}),v>t.y&&c.set({top:Math.abs(t.y)}),c.set({width:Math.abs(l-t.x)}),c.set({height:Math.abs(v-t.y)}),c.setCoords(),canvas.renderAll()}}),canvas.on("mouse:up",function(e){s=!1,canvas.off("mouse:down"),canvas.off("mouse:move"),canvas.off("mouse:up"),t.parent().removeClass("active").trigger("toolDeactivated")});break;case"blur":canvas.on("mouse:down",function(e){s=!0;var t=canvas.getPointer(e.e);l=t.x,v=t.y,rect_blur=new fabric.Rect({left:l,top:v,width:t.x-l,height:t.y-v,opacity:.1,name:"rect_blur",padding:15,hasRotatingPoint:!1}),canvas.add(rect_blur)}),canvas.on("mouse:move",function(e){if(s){var t=canvas.getPointer(e.e);l>t.x&&rect_blur.set({left:Math.abs(t.x)}),v>t.y&&rect_blur.set({top:Math.abs(t.y)}),rect_blur.set({width:Math.abs(l-t.x)}),rect_blur.set({height:Math.abs(v-t.y)}),rect_blur.setCoords(),canvas.renderAll()}}),canvas.on("mouse:up",function(e){s=!1,rect_blur.set("opacity",0),canvas.off("mouse:down"),canvas.off("mouse:move"),canvas.off("mouse:up"),t.parent().removeClass("active").trigger("toolDeactivated"),canvas.on("after:render",function(){if("undefined"!=typeof rect_blur)for(var e=this.getObjects(),t=0,a=this.size();t<a;t++)e[t].name&&"rect_blur"===e[t].name&&stackBlurCanvasRGBA("canvas",parseInt(e[t].left),parseInt(e[t].top),parseInt(e[t].getWidth()),parseInt(e[t].getHeight()),5)}),canvas.renderAll()});break;case"crop":var c,s,l,v;canvas.on("mouse:down",function(e){s=!0;var t=canvas.getPointer(e.e);l=t.x,v=t.y,c=new fabric.Rect({left:l,top:v,originX:"left",originY:"top",width:t.x-l,height:t.y-v,fill:"#fff",name:"crop",opacity:1,transparentCorners:!1,hasRotatingPoint:!1,hasControls:!1,selectable:!1,evented:!1}),canvas.add(c),canvas.moveTo(c,0)}),canvas.on("mouse:move",function(e){if(s){var t=canvas.getPointer(e.e);l>t.x&&c.set({left:Math.abs(t.x)}),v>t.y&&c.set({top:Math.abs(t.y)}),c.set({width:Math.abs(l-t.x)}),c.set({height:Math.abs(v-t.y)}),c.setCoords(),canvas.renderAll()}}),canvas.on("mouse:up",function(e){s=!1,canvas.off("mouse:down"),canvas.off("mouse:move"),canvas.off("mouse:up"),c.set("opacity",0),canvas.sendToBack(c),t.parent().removeClass("active").trigger("toolDeactivated"),canvas.lowerCanvasEl.getContext("2d").clearRect(0,0,canvas.getWidth(),canvas.getHeight())});break;case"deselect":canvas.discardActiveObject(),$(this).removeClass("active")}}}),$(document).on("click","#edit-area",function(e){switch(t=$("ul.nav li.active a"),a=$(this).parent().offset(),t.attr("class")){case"text":n=$("#palette").find("li.active a").attr("class");var o=new fabric.IText("Edit text",{fontFamily:"Arial",fontSize:20,left:e.pageX-a.left,top:e.pageY-a.top,textBackgroundColor:n,hasRotatingPoint:!1,fill:"yellow"===n?"#000":"#fff"});o.setControlsVisibility({tl:!1,tr:!0,bl:!1,br:!1,ml:!1,mt:!1,mr:!1,mb:!1,mtr:!1}),canvas.add(o),t.parent().removeClass("active").trigger("toolDeactivated")}})});